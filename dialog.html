<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      .nav-link {
        cursor: pointer;
      }

      .screen-reader-only{
        position:absolute;
        left:-10000px;
        top:auto;
        width:1px;
        height:1px;
        overflow:hidden;
      }

    </style>
  </head>
  <body>
      <main class="container">
        <nav>
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <span class="nav-link active"  id="home-link" aria-current="page">Home</span>
            </li>
            <li class="nav-item">
              <span class="nav-link" id="search-link">Search</span>
            </li>
            <li class="nav-item">
              <span class="nav-link" id="add-customer-link">Add Customer</span>
            </li>
          </ul>
        </nav>
        <div id="app">
          <h1>Welcome!</h1>
        </div>  
      <main>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

      <script>

       let data

       function loadView(options) {

        let id = typeof options.id === 'undefined'? "app" : options.id;
        let callback = typeof options.callback === 'undefined'? function(){} : options.callback;
        
        google.script.run.withSuccessHandler(function(html){
          document.getElementById(id).innerHTML = html;
          typeof options.params === 'undefined'? callback() : callback(options.params);

        })[options.function]();
       }

       function setDataForSearch() {
        google.script.run.withSuccessHandler(function(dataReturned) {
          //returns customer id, first name, and last name columns
          data = dataReturned.slice()   //make a copy of the array to avoid mutating data
        }).getDataForSearch()
       }

       function search() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase().trim()
        const searchWords = searchInput.split(/\s+/)    //split by one or more whitespaces
        const searchColumns = [1, 2]  //look in first and last name columns for matches (indices 1 and 2)

        const resultsArray = searchInput === '' ? [] : data.filter(record => {
           return searchWords.every(word => {
            return searchColumns.some(columnIndex => {    
              return record[columnIndex].toLowerCase().indexOf(word) !== -1
            })
           }) 
        })

        const searchResultsBox = document.getElementById('searchResults')
        const templateBox = document.getElementById('rowTemplate')
        const template = templateBox.content

        searchResultsBox.innerHTML = ''   

        resultsArray.forEach(function(record) {
          let tr = template.cloneNode(true)
          let customerIdColumn = tr.querySelector('.customerId')
          let firstNameColumn = tr.querySelector('.firstName')
          let lastNameColumn = tr.querySelector('.lastName')
          let deleteButton = tr.querySelector('.delete-button')
          
          customerIdColumn.textContent = record[0]
          deleteButton.dataset.customerId = record[0]    //add data attribute, to target row later
          firstNameColumn.textContent = record[1]
          lastNameColumn.textContent = record[2]

          searchResultsBox.appendChild(tr)
        })
       }
       
        function displayConfirmationDelete(e) {

          if(e.target.dataset.buttonState === 'delete') {
            e.target.previousElementSibling.classList.remove('d-none')
            e.target.classList.remove('rounded')
            e.target.textContent = 'Cancel'
            e.target.dataset.buttonState = 'cancel'
          } else {
            e.target.previousElementSibling.classList.add('d-none')
            e.target.classList.add('rounded')
            e.target.textContent = 'Delete'
            e.target.dataset.buttonState = 'delete'
          }
        }

       function deleteCustomer(e) {
        const customerId = e.target.dataset.customerId
        google.script.run.withSuccessHandler(function () {
          e.target.closest('.result-box').remove()
          const ids = data.map(record => record[0].toString().toLowerCase())
          const index = ids.indexOf(customerId.toString().toLowerCase())
          data.splice(index, 1)
        }).deleteById(customerId)
       }

       function loadSearchView() {
        loadView({function: "loadSearchView", callback: setDataForSearch});
       }

       function loadAddCustomerView() {
        loadView({function: "loadAddCustomerView"});
       }

        function loadEditCustomerView() {
        loadView({function: "loadEditCustomerView"});
       }

       document.getElementById('search-link').addEventListener('click', loadSearchView);
       document.getElementById('add-customer-link').addEventListener('click', loadAddCustomerView);
       document.getElementById('home-link').addEventListener('click', loadEditCustomerView);

       function inputEventHandler(e) {
        if (e.target.matches('#searchInput')) {
          search()
        }
       }

       function clickEventHandler(e) {
          if (e.target.matches('.delete-button')) {
            deleteCustomer(e)
        }
          if (e.target.matches('.before-delete-button')) {
            displayConfirmationDelete(e)
        }
       }

       document.getElementById('app').addEventListener('input', inputEventHandler)
       document.getElementById('app').addEventListener('click', clickEventHandler)

      </script>

  </body>
</html>























